# Strategy Viewer - GPT Artifact Visualizer

## Overview
The Strategy Viewer is a Streamlit web application that visualizes trading strategy artifacts generated by your custom GPT. It allows you to paste JSON strategy definitions and immediately see them rendered on real market charts with entry/exit signal arrows.

## Features
✅ **Real-time Market Data** - Fetches live SPY data from Polygon.io
✅ **Signal Visualization** - Green arrows (▲) for entries, red arrows (▼) for exits
✅ **Realistic Fills** - Signals snap to nearest actual candle timestamps
✅ **Performance Caching** - 5-minute cache for faster subsequent loads
✅ **Complete Strategy Display** - Shows conditions, risk management, and P&L metrics

## Running the App

```bash
streamlit run strategy_viewer.py --server.port 8510
```

Then open: http://localhost:8510

## JSON Artifact Format

```json
{
  "strategy_name": "Your Strategy Name",
  "description": "Brief description of strategy logic",
  "timeframe": "15min",
  "symbol": "SPY",
  "entry_conditions": [
    {
      "type": "indicator_cross",
      "description": "EMA 9 crosses above EMA 20",
      "direction": "long",
      "indicators": ["ema9", "ema20"]
    }
  ],
  "exit_conditions": [
    {
      "type": "indicator_cross",
      "description": "EMA 9 crosses below EMA 20",
      "direction": "close_long"
    }
  ],
  "risk_management": {
    "stop_loss": {"type": "percentage", "value": 2.0},
    "take_profit": {"type": "percentage", "value": 5.0},
    "position_size": {"type": "fixed", "value": 100}
  },
  "signals": [
    {
      "timestamp": "2025-09-30 10:00:00",
      "type": "entry_long",
      "price": 663.50,
      "reason": "EMA 9 crossed above EMA 20"
    },
    {
      "timestamp": "2025-09-30 14:30:00",
      "type": "exit_long",
      "price": 666.75,
      "reason": "EMA 9 crossed below EMA 20",
      "pnl": 325.0
    }
  ]
}
```

## Example Artifacts

Two example JSON artifacts are provided for testing:
- `test_strategy.json` - Simple EMA crossover test
- `example_strategy_artifact.json` - More complex strategy with VWAP confirmation

## Key Implementation Details

### Caching for Performance
```python
@st.cache_data(ttl=300)  # Cache for 5 minutes
def fetch_market_data(symbol, timeframe, days_back):
    from wzrd_mini_chart import get_polygon_data
    return get_polygon_data(symbol, timeframe, days_back)
```

### Timestamp Snapping
Signals automatically snap to the nearest actual candle for realistic fills:
```python
if timestamp not in data.index:
    time_diffs = abs(data.index - timestamp)
    nearest_idx = time_diffs.argmin()
    timestamp = data.index[nearest_idx]
    actual_price = data.loc[timestamp, 'close']
```

### Signal Arrows
Arrows are rendered as Plotly annotations with proper subplot positioning:
```python
fig.add_annotation(
    x=timestamp,
    y=actual_price,
    text="▲",  # or "▼" for exits
    showarrow=False,
    font=dict(size=30, color="#00FF00", family="Arial Black"),
    xref="x1",
    yref="y1",
    row=1,
    col=1
)
```

## Integration with Chart Templates

The viewer automatically applies the correct chart template based on the strategy timeframe:
- **day** - Daily chart with 9/20 EMA cloud
- **hour** - Hourly with all indicators
- **15min** - 15-minute with VWAP, prev close, 9/20, 72/89
- **5min** - 5-minute intraday view

## Testing

A Playwright test is available in `test_strategy_viewer.py` for automated verification. Note: The test requires manual trigger of the Streamlit form since pasting text doesn't auto-submit.

## Custom GPT Integration

Your custom GPT should output strategy artifacts in this JSON format. The viewer will:
1. Parse the JSON
2. Fetch real market data for the specified symbol/timeframe
3. Render the base chart with indicators
4. Overlay entry/exit arrows at signal timestamps
5. Display strategy metrics and performance

## Performance Notes

- **First load**: ~3-5 seconds (fetches data from Polygon API)
- **Cached loads**: <1 second (uses Streamlit cache)
- **Cache TTL**: 5 minutes
- **Data warmup**: Automatically fetches extra bars for indicator calculation

## Files

- `strategy_viewer.py` - Main application
- `chart_templates.py` - Chart configuration templates
- `wzrd_mini_chart.py` - Chart creation functions
- `test_strategy.json` - Example test artifact
- `example_strategy_artifact.json` - Example with VWAP confirmation
- `test_strategy_viewer.py` - Playwright automated test

## Troubleshooting

**Charts not loading?**
- Check Streamlit logs for errors
- Verify Polygon API key is set in `.env`
- Ensure signal timestamps are recent (within last 30 days)

**Arrows not showing?**
- Verify signal timestamps match the timeframe (e.g., 15-minute intervals for 15min timeframe)
- Check that signals array is properly formatted in JSON
- Signals will snap to nearest candle automatically

**Slow loading?**
- First load always fetches fresh data
- Subsequent loads use 5-minute cache
- Reduce `days_back` in chart templates for faster loading
